
<!doctype html>
<html lang="en-US">
<head>
  <title>OpenRelay Fling</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A dApp that lets you send tokens to multiple accounts at once!" />
  <link rel="stylesheet" type="text/css" href="./css/styles.css" />
  <script src="./js/anime.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/mobile-detect@1.4.1/mobile-detect.min.js"></script>
    <script>
    // function recalculateTotal() {
    //   var magnitude = web3.toBigNumber(10).pow($("#token_decimals").val() || 0);
    //   $("#total_amount").html(magnitude.mul($("#send_amount").val() || 0).mul($(".valid_address").length).toString());
    // }
    function markValid(input) {
      if(input.val() == "") {
        input.parent().removeClass("invalid_address");
        input.parent().removeClass("valid_address");
        input.parent().addClass("empty_address");
      } else if (!/0x[a-fA-F0-9]{40}/.exec(input.val())) {
        input.parent().addClass("invalid_address");
        input.parent().removeClass("valid_address");
        input.parent().removeClass("empty_address");
      } else {
        input.parent().removeClass("invalid_address");
        input.parent().removeClass("empty_address");
        input.parent().addClass("valid_address");
      }
    }
    function addressBoxChange(evt){
      if(evt.keyCode == 13) {
        $(this).val($(this).val() + ' ');
      }
      var data = $(this).val().split(" ");
      if(data.length > 1) {
        $(this).val(data[0]);
        var lastItem = $(this);
        for(var i=1; i < data.length; i++) {
          if(data[i - 1]) {
            var newItem = $('<li><input type="text" class="target_address" value="'+data[i]+'"><button class="delete_address"><i class="fas fa-times"></i></button>');
            var newItemInput = newItem.children("input");
            newItemInput.val(data[i]);
            lastItem.parent().after(newItem);
            newItemInput.focus();
            lastItem = newItemInput;
            newItemInput.on("keyup", addressBoxChange);
            markValid(newItemInput);
            newItem.children("button").on("click", function(){
              $(this).parent().remove();
            })
          }
        }
      }
      markValid($(this));
      // recalculateTotal();
    }
    $(document).ready(function(){
      if(!window.web3) {
        $("#dapp").hide()
        $("#need-web3").show()
        return;
      }
      window.web3 = new Web3(window.web3.currentProvider);
      setInterval(function(){
        window.web3.eth.getAccounts(function(err, accounts) {
          if(err || accounts.length == 0) {
            $("#dapp").hide()
            $("#need-web3").show()
          } else {
            $("#dapp").show()
            $("#need-web3").hide()
          }
        })
      }, 100);
      var multiSendAddress = "0xcc16643aa020fc23011c209e7d3f1abf2240ead1";
      var token = web3.eth.contract([{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_owner","type":"address"},{"indexed":true,"name":"_spender","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Approval","type":"event"}]);
      var multiSendContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_token","type":"address"},{"name":"addresses","type":"address[]"},{"name":"amount","type":"uint256"}],"name":"multiSend","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"addresses","type":"address[]"}],"name":"multiSendEth","outputs":[],"payable":true,"stateMutability":"payable","type":"function"}]).at(multiSendAddress);
      $(".custom_options").hide();
      $(".send_token").hide();
      $(".target_address").on("keydown", addressBoxChange);
      $(".target_address").on("keyup", addressBoxChange);
      $.ajax({url: "./tokens.json", dataType: "json"}).then(function(result){
        var keys = Object.keys(result);
        keys.sort();
        for(var key of keys) {
          $("#token_select select").append($('<option value="' + key +'">'+ key +'</option>'))
        }
        $("#token_select select").append($('<option value="_">Other...</option>'))
        var allowanceInterval;
        $("#token_select select").on("change", function(value) {
          if(allowanceInterval) {
            clearInterval(allowanceInterval);
          }
          var allowance_pending = false;
          setInterval(function() {
            web3.eth.getAccounts(function(err, accounts) {

              if(accounts.length == 0) {
                $("main").hide();
              }
              if($("#token_address").val()) {
                token.at($("#token_address").val()).allowance(accounts[0], multiSendAddress, function(err, allowance) {
                  if(allowance.gt(0)) {
                    allowance_pending = false;
                    $(".unapproved").hide();
                    $(".allowance_loading").hide();
                    $("#allowance_pending").hide();
                    $(".approved").show()
                  } else if (!allowance_pending) {
                    $(".unapproved").show();
                    $(".allowance_loading").hide();
                    $(".approved").hide()
                  }
                });
              }
            });
          }, 2000);
          $("#set_allowance").off("click");
          $("#set_allowance").on("click", function() {
            allowance_pending = true;
            $(".unapproved").hide();
            $(".approved").hide();
            $(".allowance_loading").show();
            web3.eth.getAccounts(function(err, accounts) {
              token.at($("#token_address").val()).approve(multiSendAddress, web3.toBigNumber(2).pow(256).sub(1), {from: accounts[0]}, function(err, tx) {
                if(err) {
                  $("#allowance_pending").html(err.message);
                  $(".allowance_loading").hide();
                  $(".unapproved").show();
                } else {
                  $("#allowance_pending").html('<a href="https://etherscan.io/tx/'+tx+'">View on EtherScan</a>')
                }
                $("#allowance_pending").show();
              });
            });
          });
          $(".custom_options").hide();
          $(".token_attributes").hide();
          $(".custom_options input").val("");
          $(".send_token").show();
          var token_id = $(this).val();
          if(token_id == "ETH") {
            // Special case
            $("#token_name").text("Ether");
            $("#token_decimals").val(18);
          } else if (token_id == "_"){
            $(".custom_options").show();
            $("#token_decimals").val(18);
            $("#token_name").text("Token");
            $(".token_attributes").show();
          } else if (token_id == "not-selected") {
            $(".send_token").hide();

          } else {
            $("#token_name").text(token_id);
            var details = result[token_id];
            $("#token_address").val(details.address);
            $("#token_decimals").val(details.decimals);
            $(".token_attributes").show();
          }
        });
        $(".send_token").on("click", function() {
          web3.eth.getAccounts(function(err, accounts) {
            var addresses = [];
            $(".valid_address input").each(function(){
              addresses.push($(this).val());
            })
            var magnitude = web3.toBigNumber(10).pow($("#token_decimals").val() || 0);
            if($("#token_select select").val() == "ETH") {
              var value = magnitude.mul($("#send_amount").val()).mul($(".valid_address").length);
              multiSendContract.multiSendEth(addresses, {from: accounts[0], value: value}, function(err, tx) {
                if(err) {
                  $(".submit_result").html(err);
                } else {
                  $(".submit_result").html('See your transaction on <a href="https://etherscan.io/tx/'+ tx + '">Etherscan</a>');
                }
              })
            } else {
              var value = magnitude.mul($("#send_amount").val());
              multiSendContract.multiSend($("#token_address").val(), addresses, value, {from: accounts[0]}, function(err, tx) {
                if(err) {
                  $(".submit_result").html(err);
                } else {
                  $(".submit_result").html('See your transaction on <a href="https://etherscan.io/tx/'+ tx + '">Etherscan</a>');
                }
              })
            }
          });
        })
        // $("#send_amount").on("change", recalculateTotal);
      }).catch(function(err) {
        console.log("err", err);
      });
    });
    setInterval(function() {
      if($(".invalid_address").length > 0 || $("#token_select select").val() == "not-selected" || $(".valid_address").length == 0 || ($("#token_address").val() && $(".approved:visible").length == 0) || isNaN($("#send_amount").val()) || $("#send_amount").val() <= 0 || $("#send_amount").val() == "") {
        $(".send_token").hide();
      } else {
        $("#recipient_count").text($(".valid_address").length);
        var magnitude = web3.toBigNumber(10).pow($("#token_decimals").val() || 0);
        $("#total_amount").text(magnitude.mul($("#send_amount").val() || 0).mul($(".valid_address").length).div(magnitude).toString());
        $(".send_token").show();
      }
    }, 100)
    </script>
</head>
<body class=".wrapper">
  <header>
    <h1>OpenRelay Fling</h1>
    <h2>Send tokens to multiple addresses in one shot!</h2>
    <svg version="1.1" viewBox="0 0 300 250" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(150 150)">
      <path d="m-78.187 10.524c-3.227-5.7369-11.474-5.7369-14.701 0l-27.609 59.521c-1.255 2.8685 0.71711 5.9162 3.7649 5.9162h62.031c3.0477 0 5.0198-3.227 3.7649-5.9162l-27.25-59.521zm-7.3504 17.211c-3.5856 0-6.4541-2.8685-6.4541-6.4541s2.8685-6.4541 6.4541-6.4541 6.4541 2.8685 6.4541 6.4541-2.8685 6.4541-6.4541 6.4541z" fill="#011534"/>
      <path d="m46.949-12.245l-6.9919-25.458c-0.35856-1.255-1.6135-2.1514-2.8685-1.9721l-130.34 17.39h-0.17928l-1.7928 0.17928c-14.701 2.3306-26.354 14.163-28.326 29.223-0.8964-0.53784-1.9721-0.8964-3.0478-0.8964-3.0477 0-5.5576 2.5099-5.5576 5.5577 0 3.0477 2.5099 5.5577 5.5576 5.5577 1.0757 0 2.1514-0.35856 3.0478-0.8964 1.0757 8.4261 5.3784 15.956 11.474 21.155l13.804-29.94c2.5099-4.6613 7.3504-7.5297 12.729-7.5297s10.219 2.8685 12.729 7.5297l0.17928 0.35856 13.087 28.147 105.24-45.178c1.0757-0.53784 1.6135-1.9721 1.255-3.227zm-21.155 8.6054c-1.7928 0.71712-3.7649-0.17928-4.1234-1.9721l-6.6333-24.741c-0.53784-1.7928 0.71712-3.5856 2.5099-3.7649 1.4342-0.17928 2.8685 0.71712 3.4063 2.1514l6.8126 24.741c0.17928 1.4342-0.71712 3.0477-1.9721 3.5856z" fill="#011534"/>
      <path d="m-63.048-0.092482q0-4.5374 1.5125-8.3466 1.5125-3.8092 4.2013-6.582 2.6888-2.7729 6.47-4.3413 3.7812-1.5685 8.3186-1.5685t8.3186 1.5685q3.7812 1.5685 6.47 4.3413 2.6888 2.7729 4.2013 6.582 1.5125 3.8092 1.5125 8.3466 0 4.5374-1.5125 8.3746-1.5125 3.8372-4.2013 6.61-2.6888 2.7729-6.47 4.3133-3.7812 1.5405-8.3186 1.5405t-8.3186-1.5405q-3.7812-1.5405-6.47-4.3133-2.6888-2.7729-4.2013-6.61-1.5125-3.8372-1.5125-8.3746zm3.6971 0q0 3.6971 1.1764 6.8901 1.1764 3.193 3.361 5.5457 2.1847 2.3527 5.2936 3.6971 3.109 1.3444 6.9741 1.3444t6.9741-1.3444q3.109-1.3444 5.2936-3.6971 2.1847-2.3527 3.361-5.5457 1.1764-3.193 1.1764-6.8901 0-3.6971-1.1764-6.8901-1.1764-3.193-3.361-5.5457-2.1847-2.3527-5.2936-3.6971-3.109-1.3444-6.9741-1.3444t-6.9741 1.3444q-3.109 1.3444-5.2936 3.6971-2.1847 2.3527-3.361 5.5457-1.1764 3.193-1.1764 6.8901z" fill="#00288b"/>
      <path d="m-42.545-15.611l1.7934-1.7934c4.9498 4.9498 4.9498 12.984 0 17.934l-1.7934-1.7934c3.9634-3.9634 3.9634-10.384 0-14.347z" fill="#00288b"/>
      <path d="m-42.545-15.319c-2.0322 0-3.6773-1.6451-3.6773-3.6773 0-2.0322 1.6451-3.6773 3.6773-3.6773s3.6773 1.6451 3.6773 3.6773c0 2.0322-1.6451 3.6773-3.6773 3.6773z" fill="#00288b"/>
      <path d="m-42.637-1.1239c0.37786-0.59338 1.1641-0.76786 1.7575-0.39 0.59338 0.37786 0.76786 1.1641 0.39 1.7575-0.37786 0.59338-1.1641 0.76786-1.7575 0.39-0.59338-0.37786-0.76786-1.1641-0.39-1.7575z" fill="#00288b"/>
      <path d="m-45.737 20.828c1.023 1.7719 3.2514 2.369 5.0232 1.346s2.369-3.2514 1.346-5.0232c-0.78799-1.3648-2.3274-2.0404-3.8112-1.7903l-8.1978-14.199c-0.34561-0.59861-1.1388-0.81113-1.7374-0.46552-0.59861 0.34561-0.81113 1.1388-0.46552 1.7374l8.1978 14.199c-0.97233 1.136-1.1431 2.8309-0.35512 4.1958z" fill="#00288b"/>
      <path d="m112.69-39.142c3.0663 0.93736 6.3073-0.78604 7.2447-3.8523 0.93737-3.0663-0.78604-6.3073-3.8523-7.2447-3.0663-0.93736-6.3073 0.78604-7.2447 3.8523-0.93736 3.0663 0.78605 6.3073 3.8523 7.2447z" fill="#ffcc1a"/>
      <path d="m61.876-28.134l45.554-14.046" fill-opacity="0" stroke="#ffcc1a" stroke-linecap="square" stroke-width="1.0713"/>
      <path d="m97.979-26.746c3.0663 0.93736 6.3073-0.78604 7.2447-3.8523 0.93736-3.0663-0.78604-6.3073-3.8523-7.2447-3.0663-0.93736-6.3073 0.78604-7.2447 3.8523s0.78604 6.3073 3.8523 7.2447z" fill="#ffcc1a"/>
      <path d="m47.162-15.738l45.554-14.046" fill-opacity="0" stroke="#ffcc1a" stroke-linecap="square" stroke-width="1.0713"/>
      <path d="m117.11-55.439c3.0663 0.93736 6.3073-0.78604 7.2447-3.8523 0.93737-3.0663-0.78604-6.3073-3.8523-7.2447-3.0663-0.93736-6.3073 0.78604-7.2447 3.8523s0.78605 6.3073 3.8523 7.2447z" fill="#ffcc1a"/>
      <path d="m66.291-44.431l45.554-14.046" fill-opacity="0" stroke="#ffcc1a" stroke-linecap="square" stroke-width="1.0713"/>
      <path d="m98.546-41.864c3.0663 0.93736 6.3073-0.78604 7.2447-3.8523s-0.78605-6.3073-3.8523-7.2447c-3.0663-0.93736-6.3073 0.78604-7.2447 3.8523-0.93736 3.0663 0.78604 6.3073 3.8523 7.2447z" fill="#ffcc1a"/>
      <path d="m47.73-30.857l45.554-14.046" fill-opacity="0" stroke="#ffcc1a" stroke-linecap="square" stroke-width="1.0713"/>
      <path d="m66.53-40.024c3.5495-1.1875 6.1098-4.5405 6.1098-8.4879 0-4.9393-4.0087-8.948-8.948-8.948 0-4.9393-4.0087-8.948-8.948-8.948-4.9393 0-8.9122 3.9729-8.948 8.9122-3.8922 0-7.2066 2.4893-8.4369 5.9616-4.2693-2.4253-9.7089-0.95234-12.168 3.3068-2.4696 4.2775-1.0024 9.7535 3.2752 12.223l-0.017897 0.030999c-2.4245 4.1994-1.0546 9.554 3.0437 12.085-0.07055 0.11076-0.13902 0.22357-0.20531 0.3384-2.4696 4.2775-1.0024 9.7535 3.2752 12.223l-0.017896 0.030997c-2.4696 4.2775-1.0024 9.7535 3.2752 12.223 2.8107 1.6227 6.1388 1.5457 8.7914 0.08856v-1e-7c1.6417 1.9797 4.1198 3.2414 6.8907 3.2414v0.035792c0 4.9393 4.0087 8.948 8.948 8.948 4.9393 0 8.948-4.0087 8.948-8.948 4.9393 0 8.948-4.0087 8.948-8.948 0-4.4139-3.2012-8.0846-7.407-8.8156 2.09e-4 -0.025195 3.14e-4 -0.050413 3.14e-4 -0.075657 4.9393 0 8.948-4.0087 8.948-8.948 0-4.9393-4.0087-8.948-8.948-8.948 0-4.0573-2.7049-7.4867-6.4086-8.582z" fill="#f2efef"/>
      </g>
    </svg>
  </header>
  <main>
    <section id="need-web3" hidden="true">
      You need a Web3 Client Like Metamask to use this Dapp. Make sure it's unlocked.
    </section>
    <section id="dapp">
      <h3>Select a token to send:</h3></br >
      <article id="center">
            <table>
            <th>Token:</th>
            <td id="token_select">
              <select>
                <option value="not-selected">Select a token to send.</option>
                <option value="ETH">ETH</option>
              </select>
            </td>
          </tr>
          <tr class="token_attributes" hidden="true">
            <th>Allowance:</th>
            <td><button id="set_allowance"><i class="fa fa-spinner fa-pulse fa-fw allowance_loading"></i>
<span class="unapproved" hidden="true">Set allowance</span><span class="approved" hidden="true"><i class="fa fa-check" aria-hidden="true"></i></span>
</button><br /><span id="allowance_pending" hidden="true"></span></td>
          </tr>
          <tr class="custom_options">
            <th>Token Address:</th>
            <td><input type="text" id="token_address"></input></td>
          </tr>
          <tr class="custom_options">
            <th>Token Decimals</th>
            <td><input type="number" id="token_decimals"></input></td>
          </tr>
          <tr>
            <th>Amount (to each):</th>
            <td><input type="text" id="send_amount" ></td>
          </tr>
          <tr>
            <th>Recipient Addresses:</th>
            <td> <ul id="target_address_list">
                <li><input type="text" class="target_address" >
            </ul> </td>
          </tr>
        </table>
        <button class="send_token">Split <span id="total_amount">0</span> <span id="token_name">Token</span> among <span id="recipient_count">0</span> users!</button>
        <span class="submit_result"></span>
      </article>
      <p id="sendNotice" hidden="true"></p>
    </section>
  </main>
</body>
</html>
