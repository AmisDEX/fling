
<!doctype html>
<html lang="en-US">
<head>
  <title>OpenRelay Multisender</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A dApp that lets you send tokens to multiple accounts at once!" />
  <link rel="stylesheet" type="text/css" href="./css/styles.css" />
  <script src="./js/anime.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/mobile-detect@1.4.1/mobile-detect.min.js"></script>
    <script>
    // function recalculateTotal() {
    //   var magnitude = web3.toBigNumber(10).pow($("#token_decimals").val() || 0);
    //   $("#total_amount").html(magnitude.mul($("#send_amount").val() || 0).mul($(".valid_address").length).toString());
    // }
    function markValid(input) {
      if(input.val() == "") {
        input.parent().removeClass("invalid_address");
        input.parent().removeClass("valid_address");
        input.parent().addClass("empty_address");
      } else if (!/0x[a-fA-F0-9]{40}/.exec(input.val())) {
        input.parent().addClass("invalid_address");
        input.parent().removeClass("valid_address");
        input.parent().removeClass("empty_address");
      } else {
        input.parent().removeClass("invalid_address");
        input.parent().removeClass("empty_address");
        input.parent().addClass("valid_address");
      }
    }
    function addressBoxChange(evt){
      if(evt.keyCode == 13) {
        $(this).val($(this).val() + ' ');
      }
      var data = $(this).val().split(" ");
      if(data.length > 1) {
        $(this).val(data[0]);
        var lastItem = $(this);
        for(var i=1; i < data.length; i++) {
          if(data[i - 1]) {
            var newItem = $('<li><input type="text" class="target_address" value="'+data[i]+'"><button class="delete_address">x</button>');
            var newItemInput = newItem.children("input");
            newItemInput.val(data[i]);
            lastItem.parent().after(newItem);
            newItemInput.focus();
            lastItem = newItemInput;
            newItemInput.on("keyup", addressBoxChange);
            markValid(newItemInput);
            newItem.children("button").on("click", function(){
              $(this).parent().remove();
            })
          }
        }
      }
      markValid($(this));
      // recalculateTotal();
    }
    $(document).ready(function(){
      if(!window.web3) {
        $("#dapp").hide()
        $("#need-web3").show()
        return;
      }
      window.web3 = new Web3(window.web3.currentProvider);
      setInterval(function(){
        window.web3.eth.getAccounts(function(err, accounts) {
          if(err || accounts.length == 0) {
            $("#dapp").hide()
            $("#need-web3").show()
          } else {
            $("#dapp").show()
            $("#need-web3").hide()
          }
        })
      }, 100);
      var multiSendAddress = "0x7bd9084fdd5d021c226918d86c0721cb088b9b4a";
      var token = web3.eth.contract([{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_from","type":"address"},{"indexed":true,"name":"_to","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"_owner","type":"address"},{"indexed":true,"name":"_spender","type":"address"},{"indexed":false,"name":"_value","type":"uint256"}],"name":"Approval","type":"event"}]);
      $(".custom_options").hide();
      $(".send_token").hide();
      $(".target_address").on("keydown", addressBoxChange);
      $(".target_address").on("keyup", addressBoxChange);
      $.ajax({url: "./tokens.json", dataType: "json"}).then(function(result){
        var keys = Object.keys(result);
        keys.sort();
        for(var key of keys) {
          $("#token_select select").append($('<option value="' + key +'">'+ key +'</option>'))
        }
        $("#token_select select").append($('<option value="_">Other...</option>'))
        var allowanceInterval;
        $("#token_select select").on("change", function(value) {
          if(allowanceInterval) {
            clearInterval(allowanceInterval);
          }
          var allowance_pending = false;
          setInterval(function() {
            web3.eth.getAccounts(function(err, accounts) {

              if(accounts.length == 0) {
                $("main").hide();
              }
              token.at($("#token_address").val()).allowance(accounts[0], multiSendAddress, function(err, allowance) {
                if(allowance.gt(0)) {
                  allowance_pending = false;
                  $(".unapproved").hide();
                  $(".allowance_loading").hide();
                  $("#allowance_pending").hide();
                  $(".approved").show()
                } else if (!allowance_pending) {
                  $(".unapproved").show();
                  $(".allowance_loading").hide();
                  $(".approved").hide()
                }
              });
            });
          }, 2000);
          $("#set_allowance").off("click");
          $("#set_allowance").on("click", function() {
            allowance_pending = true;
            $(".unapproved").hide();
            $(".approved").hide();
            $(".allowance_loading").show();
            web3.eth.getAccounts(function(err, accounts) {
              token.at($("#token_address").val()).approve(multiSendAddress, web3.toBigNumber(2).pow(256).sub(1), {from: accounts[0]}, function(err, tx) {
                if(err) {
                  $("#allowance_pending").html(err.message);
                  $(".allowance_loading").hide();
                  $(".unapproved").show();
                } else {
                  $("#allowance_pending").html('<a href="https://etherscan.io/tx/'+tx+'">View on EtherScan</a>')
                }
                $("#allowance_pending").show();
              });
            });
          });
          $(".custom_options").hide();
          $(".token_attributes").hide();
          $(".custom_options input").val("");
          $(".send_token").show();
          var token_id = $(this).val();
          if(token_id == "ETH") {
            // Special case
            $("#token_name").text("Ether");
          } else if (token_id == "_"){
            $(".custom_options").show();
            $("#token_decimals").val(18);
            $("#token_name").text("Token");
            $(".token_attributes").show();
          } else if (token_id == "not-selected") {
            $(".send_token").hide();

          } else {
            $("#token_name").text(token_id);
            var details = result[token_id];
            $("#token_address").val(details.address);
            $("#token_decimals").val(details.decimals);
            $(".token_attributes").show();
          }
        });
        // $("#send_amount").on("change", recalculateTotal);
      }).catch(function(err) {
        console.log("err", err);
      });
    });
    setInterval(function() {
      if($(".invalid_address").length > 0 || $("#token_select select").val() == "not-selected" || $(".valid_address").length == 0 || $(".approved:visible").length == 0 || $("#send_amount").val() <= 0 || $("#send_amount").val() == "") {
        $(".send_token").hide();
      } else {
        $("#recipient_count").text($(".valid_address").length);
        $("#total_amount").text($("#send_amount").val() * $(".valid_address").length);
        $(".send_token").show();
      }
    }, 100)
    </script>
</head>
<body class=".wrapper">
  <header>
    <h1>OpenRelay Multisender</h1>
    <svg version="1.1" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
      <rect width="300" height="300" fill="transparent"/>
      <g transform="translate(150 150)">
      <path d="m15.181 79.521c-3.7831-6.4951-11.131-9.7067-18.214-8.5129l-39.251-67.984c-1.6548-2.8661-5.4523-3.8837-8.3184-2.2289-2.8661 1.6548-3.8837 5.4523-2.2289 8.3184l39.251 67.984c-0.64539 0.75406-1.217 1.5595-1.7129 2.4051-6.4232-1.0526-12.456-2.799-18.099-5.2391-9.9237-4.2913-18.372-10.192-25.346-17.702-6.9734-7.5098-12.338-16.361-16.092-26.553-3.7549-10.192-5.6324-21.188-5.6324-32.99 0-11.801 1.8775-22.798 5.6324-32.99 3.7549-10.192 9.1191-19.043 16.092-26.553 6.9734-7.5098 15.422-13.41 25.346-17.702 5.5391-2.3953 11.454-4.1221 17.746-5.1804 2.9274 5.6571 8.8324 9.5201 15.646 9.5201 0.43687 0 0.87-0.015879 1.2988-0.047091 17.667 19.058 17.234 48.812-1.2988 67.345l0.027536 0.027536c-0.16758 0.20063-0.32419 0.41433-0.46838 0.64077-1.8092 2.8411-0.97378 6.6056 1.8673 8.4147 2.7467 1.7491 6.3565 1.0264 8.2281-1.5908 21.204-22.281 22.224-56.757 3.0588-80.211 1.1628-1.213 2.1535-2.5922 2.9331-4.0987 6.2912 1.0583 12.206 2.7851 17.746 5.1804 9.9237 4.2913 18.372 10.192 25.346 17.702 6.9734 7.5098 12.338 16.361 16.092 26.553 3.7549 10.192 5.6324 21.188 5.6324 32.99 0 11.801-1.8775 22.798-5.6324 32.99-3.7549 10.192-9.1191 19.043-16.092 26.553-6.9734 7.5098-15.422 13.41-25.346 17.702-5.6756 2.4543-11.746 4.2068-18.211 5.2574zm-31.219 16.2c0.22811 0.49598 0.48074 0.98511 0.75821 1.4657 4.8981 8.4837 15.567 11.343 24.051 6.4445 3.3135-1.913 5.7689-4.7065 7.2393-7.9062 8.4028-1.1591 16.342-3.2617 23.819-6.3077 12.069-4.9171 22.395-11.801 30.978-20.652 8.5826-8.8509 15.288-19.4 20.116-31.649 4.8277-12.248 7.2416-25.614 7.2416-40.097 0-14.483-2.4139-27.804-7.2416-39.963-4.8277-12.159-11.533-22.664-20.116-31.514-8.5826-8.8509-18.909-15.78-30.978-20.786-7.6074-3.1557-15.694-5.3168-24.261-6.4835-2.9535-5.5755-8.8143-9.3704-15.568-9.3704-6.7537 0-12.614 3.7949-15.568 9.3704-8.5665 1.1666-16.653 3.3278-24.261 6.4835-12.069 5.0065-22.395 11.935-30.978 20.786-8.5826 8.8509-15.288 19.356-20.116 31.514-4.8277 12.159-7.2416 25.48-7.2416 39.963 0 14.483 2.4139 27.849 7.2416 40.097 4.8277 12.248 11.533 22.798 20.116 31.649 8.5826 8.8509 18.909 15.735 30.978 20.652 7.468 3.0425 15.398 5.1437 23.79 6.3037z" fill="#00288b" stroke="#00288b" stroke-linecap="square" stroke-width="1"/>
      </g>
    </svg>
  </header>
  <main>
    <section id="need-web3" hidden="true">
      You need a Web3 Client Like Metamask to use this Dapp. Make sure it's unlocked.
    </section>
    <section id="dapp">
      <h3>Select the token you wish to send:</h3></br >
      <article id="center">
          <tr>
            <table>
            <th>Token:</th>
            <td id="token_select">
              <select>
                <option value="not-selected">Select a token to send.</option>
                <option value="ETH">ETH</option>
              </select>
            </td>
          </tr>
          <tr class="token_attributes" hidden="true">
            <th>Allowance:</th>
            <td><button id="set_allowance"><i class="fa fa-spinner fa-pulse fa-fw allowance_loading"></i>
<span class="unapproved" hidden="true">Set allowance</span><span class="approved" hidden="true"><i class="fa fa-check" aria-hidden="true"></i></span>
</button><span id="allowance_pending" hidden="true"></span></td>
          </tr>
          <tr class="custom_options">
            <th>Token Address:</th>
            <td><input type="text" id="token_address"></input></td>
          </tr>
          <tr class="custom_options">
            <th>Token Decimals</th>
            <td><input type="number" id="token_decimals"></input></td>
          </tr>
          <tr>
            <th>Amount Per Recipient: </th>
            <td><input type="text" id="send_amount" ></td>
          </tr>
          <tr>
            <th>Recipient Addresses:</th>
            <td> <ul id="target_address_list">
                <li><input type="text" class="target_address" >
            </ul> </td>
          </tr>
        </table>
        <button class="send_token">Split <span id="total_amount">0</span> <span id="token_name">Token</span> among <span id="recipient_count">0</span> users!</button>
      </article>
      <p id="sendNotice" hidden="true"></p>
    </section>
  </main>
</body>
</html>
